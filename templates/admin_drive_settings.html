<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Google Drive Settings - Photo Registration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        .header p {
            color: #718096;
            font-size: 0.95rem;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: white;
            text-decoration: none;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        h2 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .info-box {
            background: #e6f4ea;
            border-left: 4px solid #1e7e34;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .info-box.warning {
            background: #fff3cd;
            border-left-color: #856404;
        }

        .info-box.error {
            background: #f8d7da;
            border-left-color: #721c24;
        }

        .info-box h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }

        .info-box p, .info-box ul {
            font-size: 0.9rem;
            color: #2d3748;
            line-height: 1.6;
        }

        .info-box ul {
            margin-left: 1.5rem;
            margin-top: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }

        .file-input-label {
            display: block;
            padding: 1rem;
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: #edf2f7;
            border-color: #667eea;
        }

        .file-input-label.has-file {
            background: #e6f4ea;
            border-color: #1e7e34;
            border-style: solid;
        }

        .file-name {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #2d3748;
            font-weight: 600;
        }

        .help-text {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 0.25rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .credentials-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .credentials-info dt {
            font-weight: 600;
            color: #2d3748;
            margin-top: 0.5rem;
        }

        .credentials-info dd {
            color: #718096;
            margin-left: 0;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .setup-steps {
            counter-reset: step-counter;
            list-style: none;
            padding: 0;
        }

        .setup-steps li {
            counter-increment: step-counter;
            margin-bottom: 1.5rem;
            padding-left: 3rem;
            position: relative;
        }

        .setup-steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 2rem;
            height: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .setup-steps li strong {
            display: block;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .setup-steps li p {
            color: #718096;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .setup-steps li code {
            background: #f7fafc;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="{{ url_for('admin_settings') }}" class="back-link">‚Üê Back to Settings</a>

        <div class="header">
            <h1>üîê Google Drive API Configuration</h1>
            <p>Upload your service account credentials to enable Google Drive integration</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Current Status -->
        <div class="card">
            <h2>üìä Current Status</h2>
            {% if drive_configured %}
                <span class="status-badge active">‚úì Google Drive Configured</span>
                
                {% if drive_info %}
                <dl class="credentials-info">
                    <dt>Service Account Email:</dt>
                    <dd style="display: flex; align-items: center; gap: 0.5rem;">
                        <span id="serviceEmail">{{ drive_info.service_account_email }}</span>
                        <button onclick="copyServiceEmail()" style="padding: 0.25rem 0.75rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                            üìã Copy
                        </button>
                    </dd>
                    
                    <dt>Project ID:</dt>
                    <dd>{{ drive_info.project_id }}</dd>
                    
                    <dt>Uploaded:</dt>
                    <dd>{{ drive_info.uploaded_at }}</dd>
                    
                    <dt>Parent Folder ID:</dt>
                    <dd>{{ drive_info.parent_folder_id or 'Root folder (My Drive)' }}</dd>
                </dl>
                {% endif %}
                
                <div class="button-group">
                    <button onclick="testConnection()" class="btn btn-primary">üîç Test Connection</button>
                    <button onclick="showDeleteModal()" class="btn btn-danger">üóëÔ∏è Remove Credentials</button>
                </div>
            {% else %}
                <span class="status-badge inactive">‚úó Not Configured</span>
                <p style="color: #718096; margin-top: 1rem;">
                    Google Drive integration is not configured. Upload your service account JSON file below to enable automatic photo uploads to Google Drive.
                </p>
            {% endif %}
        </div>

        <!-- Upload Form -->
        <div class="card">
            <h2>üì§ Upload Service Account Credentials</h2>
            
            <div class="info-box warning">
                <h3>‚ö†Ô∏è Security Notice</h3>
                <p>The service account JSON file contains sensitive credentials. It will be encrypted and stored securely on the server. Never share this file publicly.</p>
            </div>

            <form method="POST" action="{{ url_for('admin_drive_settings') }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="form-group">
                    <label>Service Account JSON File</label>
                    <div class="file-input-wrapper">
                        <input type="file" name="credentials_file" id="credentialsFile" accept=".json" required onchange="updateFileName(this)">
                        <label for="credentialsFile" class="file-input-label" id="fileLabel">
                            üìÅ Click to select service account JSON file
                            <span class="file-name" id="fileName"></span>
                        </label>
                    </div>
                    <span class="help-text">Upload the JSON file downloaded from Google Cloud Console</span>
                </div>

                <div class="form-group">
                    <label for="parentFolderId">Parent Folder ID (Optional)</label>
                    <input type="text" 
                           id="parentFolderId" 
                           name="parent_folder_id" 
                           placeholder="e.g., 1a2b3c4d5e6f7g8h9i0j"
                           value="{{ drive_info.parent_folder_id if drive_info else '' }}">
                    <span class="help-text">
                        The Google Drive folder ID where event folders will be created. Leave empty to use root (My Drive).
                        Find the folder ID in the URL: <code>drive.google.com/drive/folders/<strong>FOLDER_ID_HERE</strong></code>
                    </span>
                </div>

                <div class="form-group">
                    <label for="folderNameFormat">Folder Name Format</label>
                    <select id="folderNameFormat" name="folder_name_format">
                        <option value="FirstName_LastName" {% if drive_info and drive_info.folder_name_format == 'FirstName_LastName' %}selected{% endif %}>
                            FirstName_LastName (e.g., John_Doe)
                        </option>
                        <option value="LastName_FirstName" {% if drive_info and drive_info.folder_name_format == 'LastName_FirstName' %}selected{% endif %}>
                            LastName_FirstName (e.g., Doe_John)
                        </option>
                        <option value="Event_YYYYMMDD/FirstName_LastName" {% if drive_info and drive_info.folder_name_format == 'Event_YYYYMMDD/FirstName_LastName' %}selected{% endif %}>
                            Event_YYYYMMDD/FirstName_LastName (e.g., Event_20251022/John_Doe)
                        </option>
                    </select>
                    <span class="help-text">Choose how individual photo folders will be named</span>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
                    <a href="{{ url_for('admin_settings') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>

        <!-- Setup Instructions -->
        <div class="card">
            <h2>üìö Setup Instructions</h2>
            
            <div class="info-box">
                <h3>üéØ How to Get Service Account Credentials</h3>
            </div>

            <ol class="setup-steps">
                <li>
                    <strong>Go to Google Cloud Console</strong>
                    <p>Visit <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a> and sign in with your Google account.</p>
                </li>
                <li>
                    <strong>Create or Select a Project</strong>
                    <p>Click the project dropdown at the top and create a new project (e.g., "Photo Registration") or select an existing one.</p>
                </li>
                <li>
                    <strong>Enable Google Drive API</strong>
                    <p>Go to "APIs & Services" ‚Üí "Library" ‚Üí Search for "Google Drive API" ‚Üí Click "Enable".</p>
                </li>
                <li>
                    <strong>Create Service Account</strong>
                    <p>Go to "APIs & Services" ‚Üí "Credentials" ‚Üí Click "Create Credentials" ‚Üí Select "Service Account".</p>
                </li>
                <li>
                    <strong>Configure Service Account</strong>
                    <p>Give it a name (e.g., "photo-uploader"), grant "Editor" role, and click "Done".</p>
                </li>
                <li>
                    <strong>Create & Download JSON Key</strong>
                    <p>Click on the created service account ‚Üí Go to "Keys" tab ‚Üí "Add Key" ‚Üí "Create new key" ‚Üí Choose "JSON" ‚Üí The file will download automatically.</p>
                </li>
                <li>
                    <strong>‚≠ê Share Drive Folder (CRITICAL - Use EXACT Steps!)</strong>
                    <p><strong>Service accounts have limited access to personal Drive folders. Follow these EXACT steps:</strong></p>
                    <ol style="margin-left: 1.5rem; margin-top: 0.5rem; list-style-type: lower-alpha;">
                        <li>Open the JSON file you downloaded and find the <code>"client_email"</code> line</li>
                        <li>Copy the ENTIRE email address (e.g., <code>photo-uploader@project-name-123456.iam.gserviceaccount.com</code>)</li>
                        <li>Open Google Drive in your browser (drive.google.com)</li>
                        <li>Navigate to the folder you want to use for photos</li>
                        <li>Click the folder name (don't open it, just select it)</li>
                        <li>Click the "Share" button (person with + icon) in the top toolbar</li>
                        <li>In the "Add people and groups" field, paste the service account email</li>
                        <li>Press Enter or Tab - you should see the email appear as a chip/tag</li>
                        <li>Click the dropdown next to the email and select <strong>"Editor"</strong></li>
                        <li>Uncheck "Notify people"</li>
                        <li>Click "Share" or "Done"</li>
                        <li><strong>WAIT 60 seconds</strong> for Google's servers to sync the permissions</li>
                    </ol>
                    <p style="margin-top: 0.5rem; color: #dc3545; font-weight: 600;">‚ö†Ô∏è Common mistakes: Using "Viewer" instead of "Editor", not waiting for permissions to sync, typo in email address!</p>
                    
                    <p style="margin-top: 1rem;"><strong>Alternative Option (If sharing doesn't work):</strong></p>
                    <p>Leave the "Parent Folder ID" field <strong>EMPTY</strong>. Photos will be created in the service account's own Drive, and you can access them via the shareable links that are generated. You can then move the folders to your personal Drive for review if needed.</p>
                </li>
                <li>
                    <strong>Get Folder ID</strong>
                    <p>Open the shared folder in Google Drive. Copy the folder ID from the URL (the long string after <code>/folders/</code>). Example: if URL is <code>drive.google.com/drive/folders/1a2b3c4d5e6f</code>, the ID is <code>1a2b3c4d5e6f</code>.</p>
                </li>
                <li>
                    <strong>Upload & Configure Here</strong>
                    <p>Upload the downloaded JSON file using the form above, paste the folder ID in the "Parent Folder ID" field, and click "Save Configuration".</p>
                </li>
                <li>
                    <strong>Test Connection</strong>
                    <p>Click the "üîç Test Connection" button to verify the service account can access your folder. If you see errors, make sure you completed step 7 (sharing the folder).</p>
                </li>
            </ol>

            <div class="info-box error">
                <h3>‚ùå Troubleshooting "Cannot access parent folder" Error</h3>
                <p><strong>This error means the service account doesn't have permission to the folder. To fix it:</strong></p>
                <ol style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <li>Open your service account JSON file (the one you uploaded)</li>
                    <li>Find the <code>"client_email"</code> field and copy the email address</li>
                    <li>Go to Google Drive and open the parent folder</li>
                    <li>Click the Share button (person with + icon)</li>
                    <li>Paste the service account email</li>
                    <li>Set permission to "Editor"</li>
                    <li>Click Share</li>
                    <li>Come back here and click "Test Connection" again</li>
                </ol>
            </div>

            <div class="info-box">
                <h3>üí° Tips</h3>
                <ul>
                    <li><strong>The service account MUST have "Editor" permissions on the parent folder</strong></li>
                    <li>You can find the service account email in the JSON file under the "client_email" field</li>
                    <li>You can change the parent folder ID later without re-uploading credentials</li>
                    <li>Test the connection after uploading to verify everything works</li>
                    <li>Keep a backup of your JSON file in a secure location</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; margin: 2rem;">
            <h3 style="margin-bottom: 1rem; color: #2d3748;">‚ö†Ô∏è Remove Drive Credentials?</h3>
            <p style="color: #718096; margin-bottom: 1.5rem;">
                This will remove the Google Drive service account credentials. Photo uploads to Drive will be disabled until you upload new credentials.
            </p>
            <form method="POST" action="{{ url_for('admin_drive_delete_credentials') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="button-group">
                    <button type="submit" class="btn btn-danger">Yes, Remove</button>
                    <button type="button" onclick="hideDeleteModal()" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function copyServiceEmail() {
            const email = document.getElementById('serviceEmail').textContent;
            navigator.clipboard.writeText(email).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function updateFileName(input) {
            const fileLabel = document.getElementById('fileLabel');
            const fileName = document.getElementById('fileName');
            
            if (input.files && input.files[0]) {
                fileLabel.classList.add('has-file');
                fileName.textContent = '‚úì ' + input.files[0].name;
            } else {
                fileLabel.classList.remove('has-file');
                fileName.textContent = '';
            }
        }

        function showDeleteModal() {
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function hideDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        async function testConnection() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Testing...';

            try {
                const response = await fetch('/admin/drive/test-connection', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Connection successful!\n\n' + data.message);
                } else {
                    alert('‚ùå Connection failed!\n\n' + data.error);
                }

            } catch (error) {
                alert('‚ùå Connection test failed!\n\n' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Test Connection';
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideDeleteModal();
            }
        });
    </script>
</body>
</html>
