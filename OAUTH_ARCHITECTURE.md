# OAuth 2.0 Architecture Diagram

## System Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PHOTO REGISTRATION APP                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   Frontend   â”‚         â”‚   Backend    â”‚      â”‚  Database   â”‚â”‚
â”‚  â”‚              â”‚         â”‚              â”‚      â”‚             â”‚â”‚
â”‚  â”‚ - admin_driveâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ - OAuth      â”‚â—„â”€â”€â”€â”€â–ºâ”‚ DriveOAuth  â”‚â”‚
â”‚  â”‚   _oauth.htmlâ”‚         â”‚   endpoints  â”‚      â”‚   Token     â”‚â”‚
â”‚  â”‚              â”‚         â”‚              â”‚      â”‚             â”‚â”‚
â”‚  â”‚ - Google     â”‚         â”‚ - Token      â”‚      â”‚             â”‚â”‚
â”‚  â”‚   Identity   â”‚         â”‚   exchange   â”‚      â”‚             â”‚â”‚
â”‚  â”‚   Services   â”‚         â”‚              â”‚      â”‚             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                        â”‚                               â”‚
â”‚         â”‚                        â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                        â”‚
          â”‚                        â”‚
          â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Google OAuth 2.0  â”‚  â”‚  Google Drive API    â”‚
â”‚                     â”‚  â”‚                      â”‚
â”‚ - Authorization     â”‚  â”‚ - Folder creation    â”‚
â”‚ - Token exchange    â”‚  â”‚ - File uploads       â”‚
â”‚ - Token refresh     â”‚  â”‚ - Share links        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## OAuth Connection Flow

```
ADMIN USER                FRONTEND                BACKEND              GOOGLE
    â”‚                        â”‚                       â”‚                   â”‚
    â”‚  1. Click "Connect"    â”‚                       â”‚                   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚                   â”‚
    â”‚                        â”‚                       â”‚                   â”‚
    â”‚                        â”‚  2. Initialize GSI    â”‚                   â”‚
    â”‚                        â”‚       popup           â”‚                   â”‚
    â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                        â”‚                       â”‚                   â”‚
    â”‚  3. Sign in & Grant    â”‚                       â”‚   4. Auth code    â”‚
    â”‚        permissions     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                   â”‚
    â”‚                        â”‚                       â”‚                   â”‚
    â”‚                        â”‚  5. POST code to      â”‚                   â”‚
    â”‚                        â”‚     /oauth/exchange   â”‚                   â”‚
    â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
    â”‚                        â”‚                       â”‚                   â”‚
    â”‚                        â”‚                       â”‚  6. Exchange code â”‚
    â”‚                        â”‚                       â”‚     for tokens    â”‚
    â”‚                        â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                        â”‚                       â”‚                   â”‚
    â”‚                        â”‚                       â”‚ 7. Access token + â”‚
    â”‚                        â”‚                       â”‚    Refresh token  â”‚
    â”‚                        â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                        â”‚                       â”‚                   â”‚
    â”‚                        â”‚                       â”‚  8. Save to DB    â”‚
    â”‚                        â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
    â”‚                        â”‚                       â”‚        â”‚          â”‚
    â”‚                        â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
    â”‚                        â”‚                       â”‚                   â”‚
    â”‚                        â”‚   9. Success response â”‚                   â”‚
    â”‚  10. "Connected!"      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                   â”‚
    â”‚                        â”‚                       â”‚                   â”‚
```

---

## Photo Upload Flow (with OAuth)

```
PHOTO PROCESSOR          DRIVE UPLOADER           DATABASE            GOOGLE DRIVE
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚  1. Initialize with    â”‚                       â”‚                    â”‚
      â”‚     use_oauth=True     â”‚                       â”‚                    â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚                    â”‚
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚                        â”‚  2. Get OAuth tokens  â”‚                    â”‚
      â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚                        â”‚  3. Access token +    â”‚                    â”‚
      â”‚                        â”‚     Refresh token     â”‚                    â”‚
      â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚                        â”‚  4. Check if expired  â”‚                    â”‚
      â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                    â”‚
      â”‚                        â”‚        â”‚              â”‚                    â”‚
      â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                    â”‚
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚                        â”‚ IF EXPIRED:           â”‚                    â”‚
      â”‚                        â”‚  5a. Refresh token    â”‚                    â”‚
      â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚                        â”‚  5b. New access token â”‚                    â”‚
      â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚                        â”‚  5c. Update DB        â”‚                    â”‚
      â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚                        â”‚  6. Build Drive       â”‚                    â”‚
      â”‚                        â”‚     service           â”‚                    â”‚
      â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                    â”‚
      â”‚                        â”‚        â”‚              â”‚                    â”‚
      â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                    â”‚
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚  7. Create folder      â”‚                       â”‚                    â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  8. API call          â”‚                    â”‚
      â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚                        â”‚  9. Folder ID         â”‚                    â”‚
      â”‚  10. Folder ID         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                    â”‚
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚  11. Upload photos     â”‚                       â”‚                    â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  12. Upload files     â”‚                    â”‚
      â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                        â”‚                       â”‚                    â”‚
      â”‚                        â”‚  13. Success          â”‚                    â”‚
      â”‚  14. Success           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                    â”‚
      â”‚                        â”‚                       â”‚                    â”‚
```

---

## Token Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚
â”‚ User Clicks  â”‚
â”‚  "Connect"   â”‚
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚
â”‚   Google     â”‚
â”‚    OAuth     â”‚
â”‚   Popup      â”‚
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          â”‚
â”‚  Authorization Code      â”‚
â”‚  (one-time use, 10min)   â”‚
â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ Exchange
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                â”‚
â”‚  Access Token (1 hour)         â”‚
â”‚  + Refresh Token (no expiry)   â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ Store in DB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                â”‚
â”‚  DriveOAuthToken Table         â”‚
â”‚  - access_token                â”‚
â”‚  - refresh_token               â”‚
â”‚  - token_expiry                â”‚
â”‚  - email                       â”‚
â”‚  - scope                       â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                â”‚
â”‚  Upload Photos to Drive        â”‚
â”‚  (using access_token)          â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ After 1 hour...
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                â”‚
â”‚  Access Token Expired          â”‚
â”‚  â†’ Auto-refresh with           â”‚
â”‚     refresh_token              â”‚
â”‚  â†’ Get new access_token        â”‚
â”‚  â†’ Update database             â”‚
â”‚  â†’ Continue uploading          â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema

```sql
CREATE TABLE drive_oauth_token (
    id INTEGER PRIMARY KEY,
    user_identifier VARCHAR(100) UNIQUE NOT NULL,  -- 'admin'
    access_token TEXT NOT NULL,                     -- Current access token
    refresh_token TEXT NOT NULL,                    -- Never expires
    token_expiry DATETIME NOT NULL,                 -- When access_token expires
    scope TEXT,                                     -- Granted scopes
    email VARCHAR(200),                             -- Google account email
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## File Structure

```
photo-registration-form/
â”‚
â”œâ”€â”€ app.py                          # Main Flask app
â”‚   â”œâ”€â”€ DriveOAuthToken model       # Database model
â”‚   â”œâ”€â”€ /admin/drive/oauth          # OAuth connection page
â”‚   â”œâ”€â”€ /admin/drive/oauth/status   # Check connection
â”‚   â”œâ”€â”€ /admin/drive/oauth/exchange # Token exchange
â”‚   â”œâ”€â”€ /admin/drive/oauth/disconnect
â”‚   â””â”€â”€ /admin/drive/oauth/refresh
â”‚
â”œâ”€â”€ drive_uploader.py               # Drive operations
â”‚   â””â”€â”€ DriveUploader class
â”‚       â”œâ”€â”€ __init__(use_oauth=True)
â”‚       â”œâ”€â”€ OAuth credential loading
â”‚       â”œâ”€â”€ Auto token refresh
â”‚       â””â”€â”€ Drive API operations
â”‚
â”œâ”€â”€ drive_credentials_manager.py    # Credential management
â”‚   â”œâ”€â”€ get_oauth_credentials()
â”‚   â”œâ”€â”€ refresh_oauth_token()
â”‚   â””â”€â”€ is_oauth_configured()
â”‚
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ admin_drive_oauth.html      # OAuth UI
â”‚   â”‚   â”œâ”€â”€ Google Identity Services
â”‚   â”‚   â”œâ”€â”€ Connection status
â”‚   â”‚   â””â”€â”€ Connect/Disconnect buttons
â”‚   â”‚
â”‚   â””â”€â”€ admin_dashboard.html        # Dashboard
â”‚       â””â”€â”€ "ğŸ” Drive OAuth" link
â”‚
â”œâ”€â”€ .env                            # Environment variables
â”‚   â”œâ”€â”€ GOOGLE_OAUTH_CLIENT_ID
â”‚   â”œâ”€â”€ GOOGLE_OAUTH_CLIENT_SECRET
â”‚   â””â”€â”€ GOOGLE_OAUTH_REDIRECT_URI
â”‚
â”œâ”€â”€ requirements.txt                # Dependencies
â”‚   â””â”€â”€ requests>=2.31.0
â”‚
â”œâ”€â”€ migrate_oauth.py                # Database migration
â”‚
â””â”€â”€ Documentation/
    â”œâ”€â”€ OAUTH_QUICKSTART.md         # 5-minute setup
    â”œâ”€â”€ OAUTH_IMPLEMENTATION.md     # Full docs
    â”œâ”€â”€ OAUTH_SUMMARY.md            # Summary
    â””â”€â”€ OAUTH_ARCHITECTURE.md       # This file
```

---

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ENVIRONMENT VARIABLES (.env)        â”‚
â”‚  - OAuth Client ID (public)             â”‚
â”‚  - OAuth Client Secret (secret)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         APPLICATION LAYER               â”‚
â”‚  - CSRF Protection on all POST routes   â”‚
â”‚  - Login required for OAuth routes      â”‚
â”‚  - Server-side token validation         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DATABASE LAYER                  â”‚
â”‚  - Encrypted at rest (filesystem)       â”‚
â”‚  - Access tokens expire (1 hour)        â”‚
â”‚  - Refresh tokens stored securely       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         GOOGLE LAYER                    â”‚
â”‚  - OAuth 2.0 standard protocol          â”‚
â”‚  - Token revocation support             â”‚
â”‚  - Scope-limited permissions            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Comparison: Service Account vs OAuth

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SERVICE ACCOUNT (Old)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   App    â”‚â”€â”€JSONâ”€â”€â”€â–ºâ”‚ Service  â”‚â”€â”€APIâ”€â”€â”€â”€â–ºâ”‚  Google  â”‚  â”‚
â”‚  â”‚          â”‚   Key    â”‚ Account  â”‚   Call   â”‚  Drive   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  âŒ No storage quota (fails immediately)                     â”‚
â”‚  âŒ Complex file sharing required                            â”‚
â”‚  âŒ Service account owns files                               â”‚
â”‚  âŒ Manual JSON key management                               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      OAUTH 2.0 (New)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   App    â”‚â”€â”€OAuthâ”€â”€â–ºâ”‚   Your   â”‚â”€â”€APIâ”€â”€â”€â”€â–ºâ”‚  Google  â”‚  â”‚
â”‚  â”‚          â”‚  Token   â”‚ Account  â”‚   Call   â”‚  Drive   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  âœ… Uses your Drive quota                                    â”‚
â”‚  âœ… Direct upload to your Drive                              â”‚
â”‚  âœ… You own all files                                        â”‚
â”‚  âœ… One-click connect/disconnect                             â”‚
â”‚  âœ… Automatic token refresh                                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API Endpoints

### GET /admin/drive/oauth
Returns the OAuth connection page with status display

### GET /admin/drive/oauth/status
```json
Response (connected):
{
    "connected": true,
    "email": "user@gmail.com",
    "expires_at": "2025-10-22T14:30:00",
    "is_expired": false
}

Response (not connected):
{
    "connected": false
}
```

### POST /admin/drive/oauth/exchange
```json
Request:
{
    "code": "4/0AY0e-g7X..."
}

Response:
{
    "success": true,
    "email": "user@gmail.com",
    "expires_at": "2025-10-22T14:30:00"
}
```

### POST /admin/drive/oauth/disconnect
```json
Response:
{
    "success": true,
    "message": "Disconnected successfully"
}
```

### POST /admin/drive/oauth/refresh
```json
Response:
{
    "success": true,
    "expires_at": "2025-10-22T15:30:00"
}
```

---

## Dependencies

```
google-api-python-client    # Drive API client
google-auth                # OAuth credential handling
requests                   # HTTP requests for token exchange
Flask                      # Web framework
Flask-SQLAlchemy          # Database ORM
Flask-WTF                 # CSRF protection
```

---

This architecture provides a secure, user-friendly OAuth 2.0 implementation that allows direct uploads to personal Google Drive accounts with automatic token management and refresh.
